name: Build and publish cf-auth-sim image

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag to publish (ex: 1.0.0, dev)'
        required: true
        default: 'dev'
      latest:
        description: 'latest'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    name: Build cf-auth-sim and push to GHCR
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-docker-action@v4
        with:
          daemon-config: |
            {
              "features": {
                "containerd-snapshotter": true
              }
            }

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build image with ./run.sh docker-build cf-auth-sim
        id: build
        run: |
          # Build image with ./run.sh docker-build cf-auth-sim
          # Compose tags list: always include the provided tag; optionally include 'latest'
          TAG_INPUT="${{ inputs.tag }}"
          TAGS="$TAG_INPUT"
          if [ "${{ inputs.latest }}" = "true" ] || [ "${{ inputs.latest }}" = "True" ]; then
            TAGS="$TAGS latest"
          fi

          echo "Building keycloak-cloudfront-auth-simulator with tags: $TAGS"
          # Use the repo's run.sh wrapper which delegates to scripts/docker-build.sh
          ./run.sh docker-build cf-auth-sim $TAGS -- \
              --platform linux/amd64,linux/arm64 \
              --cache-to type=gha,mode=max \
              --cache-from type=gha \
              --provenance=false

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and push to GHCR
        run: |
          OWNER="${{ github.repository_owner }}"
          IMAGE_NAME="keycloak-cloudfront-auth-simulator"
          SRC_TAG="${{ inputs.tag }}"

          # Primary push: ghcr.io/<owner>/<image>:<tag>
          docker tag ${IMAGE_NAME}:${SRC_TAG} ghcr.io/${OWNER}/${IMAGE_NAME}:${SRC_TAG}
          docker push ghcr.io/${OWNER}/${IMAGE_NAME}:${SRC_TAG}

          # Optionally push latest
          if [ "${{ inputs.latest }}" = "true" ] || [ "${{ inputs.latest }}" = "True" ]; then
            docker tag ${IMAGE_NAME}:latest ghcr.io/${OWNER}/${IMAGE_NAME}:latest
            docker push ghcr.io/${OWNER}/${IMAGE_NAME}:latest
          fi

      - name: Output published image
        run: |
          OWNER="${{ github.repository_owner }}"
          IMAGE_NAME="keycloak-cloudfront-auth-simulator"
          echo "published=ghcr.io/${OWNER}/${IMAGE_NAME}:${{ inputs.tag }}" >> $GITHUB_OUTPUT
